# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Educational project demonstrating the OpenAI Agent SDK (formerly OpenAI Agents). Provides working examples of agents, tools, guardrails, and hooks with comprehensive inline documentation.

## Development Commands

This project uses Poetry with a `run.sh` script (also accessible via Makefile).

```bash
# Environment setup
make install-dev          # Install all dev dependencies (test, lint, typing)
./run.sh install:all      # CI alternative: non-interactive install

# Code quality (run before committing)
make format               # Format with black and isort
make lint                 # Run mypy, flake8, pylint
make check                # Format + lint + tests (local development)
make pre-commit           # Format and lint on changed files only

# Testing
make test                 # Run all tests
make test-file f=tests/test_file.py  # Run specific test file
./run.sh tests:pattern "test_name"   # Run tests matching pattern
./run.sh tests:file tests/test_file.py -v  # Run specific file with verbose
```

## Project Structure

```
src/openai_agent_sdk_tutorial/
├── app.py                   # Main entry point - CLI and Gradio chat interface
├── agent.py                 # Agent configuration and Runner.run()
├── tool.py                  # Function tools, tool guardrails, agents-as-tools
├── guardrail.py             # Input/output guardrails
├── hook.py                  # RunHooks and AgentHooks implementations
└── util.py                  # Logging configuration
```

## Architecture Flow

```
User Input → Input Guardrails (Agent) → Dynamic Instructions → Agent Loop → Output Guardrails → Return
                                              │
                                              ├─ LLM Call (hooks: on_llm_start/end)
                                              └─ Tool Calls
                                                   ├─ Input Guardrail (validate args)
                                                   ├─ Execute Tool (hooks: on_tool_start/end)
                                                   └─ Output Guardrail (validate result)
```

## Key SDK Concepts

### Agent Configuration (app.py)
- `Agent(name, instructions, model, tools, hooks, input_guardrails, output_guardrails)`
- Dynamic instructions: `def generate_instructions(ctx: RunContextWrapper, agent: Agent) -> str`
- `Runner.run(starting_agent, input, context, max_turns, hooks, run_config, session)`

### Function Tools (tools.py)
```python
@function_tool(description_override="...")
def my_tool(arg: str, optional: str = "default") -> dict:
    return {"result": "value"}

# Attach guardrails after decoration
my_tool.tool_input_guardrails = cast(list[ToolInputGuardrail], [my_guardrail])
```
**Tool naming**: Must match `^[a-zA-Z0-9_-]+$` (no spaces)

### Tool Guardrails (tools.py)
- `@tool_input_guardrail` - Validates BEFORE tool executes
- `@tool_output_guardrail` - Validates AFTER tool executes

Response behaviors:
```python
ToolGuardrailFunctionOutput.allow()           # Proceed normally
ToolGuardrailFunctionOutput.reject_content()  # Block but agent continues
ToolGuardrailFunctionOutput.raise_exception() # Halt execution
```

### Agents as Tools (tools.py)
```python
agent_tool = cast(FunctionTool, my_agent.as_tool(
    tool_name="my_agent_tool",  # No spaces!
    tool_description="What this agent-tool does",
))
```

| Aspect | as_tool() | Handoff |
|--------|-----------|---------|
| Input | Generated by caller | Full conversation history |
| Control | Returns to caller | New agent takes over |

### Hooks (hooks.py)

| Type | Scope | Attached to |
|------|-------|-------------|
| `RunHooks` | All agents in run | `Runner.run(hooks=...)` |
| `AgentHooks` | Single agent only | `Agent(hooks=...)` |

Methods: `on_agent_start/end`, `on_tool_start/end`, `on_llm_start/end`, `on_handoff`

### Agent Guardrails (different from tool guardrails)
- `@input_guardrail` / `@output_guardrail` - Attached to Agent
- Always raises exception on trigger (no graceful recovery)

## Key SDK Imports

```python
from agents import (
    Agent, Runner, RunConfig, RunContextWrapper,
    function_tool, FunctionTool,
    tool_input_guardrail, tool_output_guardrail, ToolGuardrailFunctionOutput,
    input_guardrail, output_guardrail, GuardrailFunctionOutput,
    RunHooks, AgentHooks,
    SQLiteSession, trace,
    InputGuardrailTripwireTriggered, OutputGuardrailTripwireTriggered, MaxTurnsExceeded,
)
```

## Running the Application

```bash
export OPENAI_API_KEY="your-key"
export PUSHOVER_TOKEN="your-token"  # Optional: for push notifications
export PUSHOVER_USER="your-user"    # Optional: for push notifications

python src/openai_agent_sdk_tutorial/app.py
```

## Important Notes

- **RunContextWrapper**: `ctx.context` contains custom data from `Runner.run(context=...)`, shared across instructions, guardrails, tools, and hooks
- **Tool vs Agent Guardrails**: Tool guardrails can recover via `reject_content()`; agent guardrails always raise exceptions
- **Naming**: Tool names use `snake_case` only; agent names can have spaces
